<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-logo">Ralph <span>Dashboard</span></div>
                <div class="header-status">
                    <div class="status-dot" id="connection-dot"></div>
                    <span id="connection-text">Connecting...</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-icon tooltip" id="theme-toggle" data-tooltip="Toggle theme">&#9790;</button>
            </div>
        </header>

        <!-- Left Sidebar: Projects -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-section-title">Projects</div>
            </div>
            <div class="project-list" id="project-list">
                <div class="empty-state">
                    <div class="empty-state-text" style="font-size: 12px;">Loading projects...</div>
                </div>
            </div>
            <div class="sidebar-actions">
                <button class="btn btn-primary" onclick="Projects.launch()" title="Launch selected project">
                    &#9654; Launch
                </button>
                <div style="display: flex; gap: 4px; margin-top: 4px;">
                    <button class="btn btn-sm" onclick="Projects.pause()" title="Pause" style="flex: 1;">&#10074;&#10074; Pause</button>
                    <button class="btn btn-sm btn-success" onclick="Projects.resume()" title="Resume" style="flex: 1;">&#9654; Resume</button>
                    <button class="btn btn-sm btn-danger" onclick="Projects.stop()" title="Stop" style="flex: 1;">&#9632; Stop</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Tab Bar -->
            <div class="tab-bar">
                <div class="tab active" data-tab="tasks">Tasks</div>
                <div class="tab" data-tab="logs">Logs</div>
                <div class="tab" data-tab="config">Config</div>
                <div style="flex: 1;"></div>
                <span id="main-project-name" style="font-size: 12px; color: var(--text-muted); padding-right: 12px;">
                    Select a project
                </span>
            </div>

            <div class="tab-content">
                <!-- Tasks Panel -->
                <div class="tab-panel active" id="panel-tasks">
                    <div class="task-toolbar">
                        <input type="text" class="search-input" placeholder="Search tasks..."
                               oninput="Tasks.filterBySearch(this.value)">
                        <select class="select-input" onchange="Tasks.filterByStatus(this.value)">
                            <option value="">All statuses</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="blocked">Blocked</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="deferred">Deferred</option>
                        </select>
                        <select class="select-input" onchange="Tasks.filterByPriority(this.value)">
                            <option value="">All priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <span id="tasks-count" style="font-size: 12px; color: var(--text-muted);"></span>
                        <div style="flex: 1;"></div>
                        <button class="btn btn-sm" onclick="Tasks.showDependencyTree()">&#128722; Dependency Tree</button>
                        <button class="btn btn-sm btn-primary" onclick="Tasks.showAddModal()">+ Add Task</button>
                    </div>
                    <div style="flex: 1; overflow: auto;">
                        <table class="task-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th>Title</th>
                                    <th style="width: 110px;">Status</th>
                                    <th style="width: 90px;">Priority</th>
                                    <th style="width: 140px;">Dependencies</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-body">
                                <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    Select a project to view tasks
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Logs Panel -->
                <div class="tab-panel" id="panel-logs">
                    <div class="log-toolbar">
                        <input type="text" class="search-input" id="log-search" placeholder="Search logs..."
                               onkeydown="if(event.key==='Enter') Logs.search()">
                        <button class="btn btn-sm" onclick="Logs.search()">Search</button>
                        <button class="btn btn-sm btn-primary" id="log-autoscroll-btn" onclick="Logs.toggleAutoScroll()">
                            &#8615; Auto-scroll ON
                        </button>
                        <button class="btn btn-sm" onclick="Logs.clear()">Clear</button>
                        <div style="flex: 1;"></div>
                        <span id="log-status" style="font-size: 12px; color: var(--text-muted);"></span>
                        <button class="btn btn-sm" onclick="Logs.exportLogs('txt')">Export TXT</button>
                        <button class="btn btn-sm" onclick="Logs.exportLogs('json')">Export JSON</button>
                    </div>
                    <div class="log-container">
                        <div class="log-output" id="log-output">
                            <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                                Select a project and switch to this tab to view logs
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Config Panel -->
                <div class="tab-panel" id="panel-config">
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">Parsed Configuration</div>
                        <div id="config-info" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius); border: 1px solid var(--border);">
                            <span style="color: var(--text-muted);">Select a project to view its configuration</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <div style="font-size: 13px; font-weight: 600;">config.toml Editor</div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-sm" onclick="Config.reset()">Revert</button>
                            <button class="btn btn-sm btn-primary" onclick="Config.save()">Save</button>
                        </div>
                    </div>
                    <textarea class="config-editor" id="config-editor" spellcheck="false"
                              placeholder="# Select a project to edit its config.toml"></textarea>
                </div>
            </div>
        </main>

        <!-- Right Sidebar: Metrics -->
        <aside class="metrics-panel">
            <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 10px;">
                System Metrics
            </div>

            <!-- CPU -->
            <div class="metric-card" id="metric-cpu">
                <div class="metric-card-header">
                    <span class="metric-card-title">CPU</span>
                </div>
                <div class="metric-value good">0%</div>
                <div class="metric-sub">Loading...</div>
                <div class="metric-bar"><div class="metric-bar-fill good" style="width: 0%"></div></div>
                <canvas class="metric-chart" id="chart-cpu"></canvas>
                <div class="core-grid" id="core-grid"></div>
            </div>

            <!-- Memory -->
            <div class="metric-card" id="metric-memory">
                <div class="metric-card-header">
                    <span class="metric-card-title">Memory</span>
                </div>
                <div class="metric-value good">0%</div>
                <div class="metric-sub">Loading...</div>
                <div class="metric-bar"><div class="metric-bar-fill good" style="width: 0%"></div></div>
                <canvas class="metric-chart" id="chart-memory"></canvas>
            </div>

            <!-- GPU -->
            <div class="metric-card" id="metric-gpu">
                <div class="metric-card-header">
                    <span class="metric-card-title">GPU</span>
                </div>
                <div class="metric-value good">N/A</div>
                <div class="metric-sub">Detecting...</div>
                <div class="metric-bar"><div class="metric-bar-fill good" style="width: 0%"></div></div>
                <canvas class="metric-chart" id="chart-gpu"></canvas>
            </div>

            <!-- Disk -->
            <div class="metric-card" id="metric-disk">
                <div class="metric-card-header">
                    <span class="metric-card-title">Disk</span>
                </div>
                <div class="metric-value good">0%</div>
                <div class="metric-sub">Loading...</div>
                <div class="metric-bar"><div class="metric-bar-fill good" style="width: 0%"></div></div>
            </div>
        </aside>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-bar-left">
                <span id="status-active-count">0 active agents</span>
                <span id="status-ralph" style="color: var(--text-muted);">ralph-tui: checking...</span>
            </div>
            <div class="status-bar-right">
                <span id="status-timestamp"></span>
            </div>
        </footer>
    </div>

    <!-- Modals -->

    <!-- Launch Project Modal -->
    <div class="modal-overlay" id="launch-modal">
        <div class="modal">
            <div class="modal-title">Launch Project: <span id="launch-project-name"></span></div>
            <div class="form-group">
                <label class="form-label">Model</label>
                <input type="text" class="form-input" id="launch-model" value="qwen2.5-coder:7b"
                       placeholder="e.g., qwen2.5-coder:7b">
            </div>
            <div class="form-group">
                <label class="form-label">Max Iterations</label>
                <input type="number" class="form-input" id="launch-iterations" value="50" min="1" max="1000">
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="launch-headless" checked disabled>
                    Headless mode (sempre attivo dalla dashboard)
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.hideModal('launch-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="Projects.confirmLaunch()">&#9654; Launch</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-title">Delete Project</div>
            <p style="margin-bottom: 16px;">
                Are you sure you want to delete <strong id="delete-project-name"></strong>?
                This action cannot be undone.
            </p>
            <div class="modal-footer">
                <button class="btn" onclick="App.hideModal('delete-modal')">Cancel</button>
                <button class="btn btn-danger" onclick="Projects.confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="add-task-modal">
        <div class="modal">
            <div class="modal-title">Add New Task</div>
            <div class="form-group">
                <label class="form-label">Title *</label>
                <input type="text" class="form-input" id="new-task-title" placeholder="Task title">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="new-task-description" rows="3" placeholder="Task description"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-input" id="new-task-priority">
                    <option value="high">High</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Dependencies (comma-separated IDs)</label>
                <input type="text" class="form-input" id="new-task-deps" placeholder="e.g., 1, 3, 5">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.hideModal('add-task-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="Tasks.confirmAdd()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal-overlay" id="edit-task-modal">
        <div class="modal">
            <div class="modal-title">Edit Task</div>
            <input type="hidden" id="edit-task-id">
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" id="edit-task-title">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="edit-task-description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-input" id="edit-task-status">
                    <option value="pending">Pending</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="blocked">Blocked</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="deferred">Deferred</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-input" id="edit-task-priority">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Dependencies (comma-separated IDs)</label>
                <input type="text" class="form-input" id="edit-task-deps">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.hideModal('edit-task-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="Tasks.confirmEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Dependency Tree Modal -->
    <div class="modal-overlay" id="dep-tree-modal">
        <div class="modal" style="min-width: 500px;">
            <div class="modal-title">Task Dependency Tree</div>
            <div class="dep-tree" id="dep-tree-content"></div>
            <div class="modal-footer">
                <button class="btn" onclick="App.hideModal('dep-tree-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Scripts -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/websocket.js"></script>
    <script src="/static/js/performance.js"></script>
    <script src="/static/js/projects.js"></script>
    <script src="/static/js/tasks.js"></script>
    <script src="/static/js/logs.js"></script>
    <script src="/static/js/config.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
